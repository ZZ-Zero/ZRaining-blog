title: node+phantomJS实现html转pdf
date: 2016-03-23 22:11:19
tags: 
    - node
    - javascript
categories: 
    - 技术类
    - node.js
---

前段时间帮后台前辈写html转pdf的接口，跳了不少坑Orz。

技术选型大概是选用了phantomJS。
phantomJS其本身是一个强大的命令行工具，可在服务器访问网页，并进行各种操作，然后生成图片或pdf文件。
原理是大致就是在服务器实现了一个webkit内核的浏览器，因此网页样式都可以完全保留。
并且phantomJS可以模拟大量的浏览器事件，因此也常被用于前端自动化测试中的一环。

最初选型的时候考虑到了需要完整的保留其样式的基础。在众多选择中只有node能做到直接将html代码直接转化成pdf。
毕竟只有node用的js是前端语言，这种状况也是可以理解。

然后就是工具的选择，能做到转pdf的工具有两个。
1. phantomJS
2. wkhtmltopdf

前者功能更广泛，开源维护更活跃，支持的功能也更多。自然就选择前者了。

然后如何在后台调用？
最初使用的是一个叫做phantomjs-node的模块。可以将phantomJS直接当做node的中间件来调用。
功能也比较全面，各项设置方法俱全。
文档说明不多。
首先通过npm安装：
    $ npm install phantom --save
然后根据phantom本身的语法和其方法进行对照即可。
理论上phantom的所有方法phantomjs-node都可使用。

然而在本人愉快的施工时发现该工具在使用onCallBack时会报错。寻求解法未果。了解到该为固有bug。
而为了实现项目所需效果必须要使用该callback获取到对应数据。万般无奈只好寻求其他方法。
然而github上有关的项目除了phantomjs-node外大多都是年久失修，多年未有维护。
只好抡起袖子自己上了。前面一系列动作已经花去了大量时间。最后回到了原点。

如何让phantomJS顺利运行并将文件返回给接口？成了最大的问题。
毕竟一届前端，对服务器只是略微了解，并不算熟悉。
最后和同行交流，得知了可以直接用node操作命令行，然后返回该命令的输出。
虽然不够优雅，但是也算是一种十分可行的办法。
